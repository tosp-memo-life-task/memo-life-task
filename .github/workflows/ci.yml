name: CI
on:
  push:
    branches:
      - develop
  pull_request:

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - uses: nrwl/nx-set-shas@v3
      - run: npm ci

      - name: Make envfile
        uses: SpicyPizza/create-envfile@v1.3
        with:
          envkey_NODE_ENV: ${{ secrets.NODE_ENV }}
          envkey_TZ: ${{ secrets.TZ }}
          envkey_SALT: ${{ secrets.SALT }}
          envkey_API_HOST: ${{ secrets.API_HOST }}
          envkey_API_PORT: ${{ secrets.API_PORT }}
          envkey_API_PREFIX: ${{ secrets.API_PREFIX }}
          envkey_API_VERSION: ${{ secrets.API_VERSION }}
          envkey_DB_HOST: ${{ secrets.DB_HOST }}
          envkey_DB_PORT: ${{ secrets.DB_PORT }}
          envkey_DB_USERNAME: ${{ secrets.DB_USERNAME }}
          envkey_DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          envkey_DB_NAME: ${{ secrets.DB_NAME }}
          envkey_DB_SYNCHRONIZE: ${{ secrets.DB_SYNCHRONIZE }}
          envkey_JWT_IGNORE_EXPIRATION: ${{ secrets.JWT_IGNORE_EXPIRATION }}
          envkey_JWT_ACCESS_EXPIRATION_TIME: ${{ secrets.JWT_ACCESS_EXPIRATION_TIME }}
          envkey_JWT_ACCESS_SECRET: ${{ secrets.JWT_ACCESS_SECRET }}

      - name: MySql setup
        uses: mirromutth/mysql-action@v1.1
        with:
          host port: ${{ secrets.DB_PORT }}
          container port: ${{ secrets.DB_PORT }}
          mysql database: ${{ secrets.DB_NAME }}
          mysql user: ${{ secrets.DB_USERNAME }}
          mysql password: ${{ secrets.DB_PASSWORD }}

      - name: Wait for MySQL
        run: |
          while ! mysqladmin ping --host=127.0.0.1 --password=${{ secrets.DB_PASSWORD }} --silent; do
            sleep 1
          done

      - run: npx nx workspace-lint
      - run: npx nx format:check
      - run: npx nx affected --target=lint --parallel=3
      - run: npx nx affected --target=test --parallel=3 --ci --code-coverage
      - run: npx nx affected --target=build --parallel=3
